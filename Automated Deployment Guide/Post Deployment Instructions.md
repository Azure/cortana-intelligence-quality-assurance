# [Quality Assurance for Manufacturing](https://go.microsoft.com/fwlink/?linkid=831187)

This document is focusing on the post deployment instructions for the automated deployment through [Cortana Intelligence Solutions](https://gallery.cortanaintelligence.com/solutions). The source code of the solution as well as manual deployment instructions can be found [here](https://github.com/Azure/cortana-intelligence-quality-assurance-manufacturing/tree/master/Manual%20Deployment%20Guide).

# Architecture
The architecture diagram shows various Azure services that are deployed by [Quality Assurance for Manufacturing Solution](https://cloud.githubusercontent.com/assets/16708375/20932195/acb87330-bbcb-11e6-8a89-27d8b6e17bdf.png) using [Cortana Intelligence Solutions](https://gallery.cortanaintelligence.com/solutions), and how they are connected to each other in the end to end solution.

![Solution Diagram](https://cloud.githubusercontent.com/assets/16708375/20932195/acb87330-bbcb-11e6-8a89-27d8b6e17bdf.png)


1.	The Manufacturing Assembly Line simulation data is streamed by the newly deployed **Azure Web Jobs**. 

2.	This synthetic data feeds into the **Azure Event Hubs** as data points/events, that will be consumed in the rest of the solution flow and stored in **Azure SQL Data Warehouse**.

3.	There is 1 **Azure Stream Analytics** job used in this pattern to provide near real-time analytics on the input stream from the **Azure Event Hub** and store the results in long term storage. Both jobs filter through the input data and pass the data points along to a **Azure Machine Learning** endpoint sending the results to a **Power BI Dashboard**.

4.	Finally, **Power BI** is used for results visualization.
</Guide>

All the resources listed above besides Power BI are already deployed in your subscription. The following instructions will guide you on how to monitor things that you have deployed and create visualizations in Power BI.

# Post Deployment Instructions
Once the solution is deployed to the subscription, you can see the services deployed by clicking the resource group name on the final deployment screen in the CIS.

This will show all the resources under this resource groups on [Azure management portal](https://portal.azure.com/).

After successful deployment, the entire solution is automatically started on cloud. You can monitor the progress from the following resources.

## **Monitor progress**

1. Web Jobs
	
	The production line data is generated by an Azure Web Job (of type Continuous).
		
2. Azure Event Hub
	    
    Azure Event Hub receives all of the events sent by the continuous web job. You can monitor the hub activity by logging into the Azure Portal, locating the service bus namespace and finding 
	the event hub associated with the resource group of the deployed solution.
	
3. ML WebService
	
    Five machine learning models are deployed as Azure WebServices and are consumed by the Azure Stream Analytics job.
	
	* You can view your machine learning web services by going [here](https://studio.azureml.net) and in the machine learning workspace associated with the resource group of the deployed solution.
	

## **Visualization**
Power BI dashboard can be used to visualize the real-time failure predictions. The following instructions will guide you to build a dashboard to visualize data from database and from real-time data stream.

Note that you need to follow instructions for visualizing data from real-time data stream in order to get data flowing into the data warehouse. This is because the Stream Analytics job which you will start from the instructions below will flow data both to the data warehouse as well as Power BI.

### Visualize Data From Real-time Data Stream

The essential goal of this part is to visualize the predictions in real time as the devices pass through the manufacturing assembly lines. Power BI can connect to a real-time data stream through Azure Stream Analytics.

> Note: A [Power BI online](http://www.powerbi.com/) account is required to perform the following steps. If you don't have an account, you can [create one here](https://powerbi.microsoft.com/pricing).

1.  Add Power BI output in Azure Stream Analytics (ASA).

  - Navigate to [Azure management portal](https://portal.azure.com) and login with your username and password. On the left tab click ***Resource groups*** and search for the solution you just deployed. The name of the resource group is the same as the name you choose for the solution.

  - Click your resource group and locate the stream analytics job. The name of the job should be: YourSolutionName+"saJob". Click the Stream Analytics job and then click **'Outputs'** from the panel on the right.

  - On the new window, click **'+Add'** on the top, and then it will show a window asking for information of the output. Under **'Sink'**, choose **'Power BI'**, then click **'Authorize'**. In the pop out window, log in with your Power BI account.

  - Once you successfully authorize your Power BI account, fill in other information as follows. Set the **Output Alias** as **'outputPBI'**. Set your **'Dataset Name'** and **'Table Name'**. Click **'Create'** once you finish.

  - Now you have added the Power BI output, you can click ![Start](Figures/PowerBI-2.png) at the top of the page to start the Stream Analytics job. You will get a confirmation message (e.g. 'Streaming Job started successfully').

  - For other details, you can refer to the instructions in [Azure Stream Analytics & Power BI: A real-time analytics dashboard for real-time visibility of streaming data](https://azure.microsoft.com/en-us/documentation/articles/stream-analytics-power-bi-dashboard/).

2. Login on [Power BI online](http://www.powerbi.com)

    -   On the left panel Datasets section in My Workspace, you should be able to see a new dataset showing on the left panel of Power BI. This is the streaming data you pushed from Azure Stream Analytics in the previous step.

    -   Make sure the ***Visualizations*** pane is open and is shown on the
    right side of the screen.

3. Now you can directly create a visualization on Power BI online. We will use this example to show you how to create the "Demand by Timestamp" tile:
	-	Click dataset on the left panel Datasets section.

	-	Click **"Line Chart"** icon.![Line Chart](Figures/PowerBI-3.png)

	-	Click relevant field you want to visualize in **Fields** panel.

	-	Click **“time”** and make sure it shows under "Axis". Click the variable you want to visualize and make sure it shows under "Values".

	-	Click **'Save'** on the top and give any name to the report. The report will then be shown in Reports section in the Navigator pane on left.

	-	Click **“Pin Visual”**![](Figures/PowerBI-4.png) icon on top right corner of this line chart, a "Pin to Dashboard" window may show up for you to choose a dashboard. Please select the relevant report, then click "Pin".

### Visualize Data from Database

The essential goal of this part is to get the failure predictions and visualize it. Power BI can directly connect to an Azure SQL DW as its data source, where the prediction results are stored. Note that this is mainly for visualizing historical predictions rather than acting upon predictions in real time. For real-time visualizations on the predicted failures as they pass through the assembly line, further instructions are given below on visualizing streaming datasets.

> Note:  1) In this step, the prerequisite is to download and install the free software [Power BI desktop](https://powerbi.microsoft.com/desktop). 2) We recommend you start this process 2-3 hours after you deploy the solution so that you have more data points to visualize.

1.  Get the database credentials.

    You can find your database and server name on the page when you finish your deployment. The SQL username and password will be the ones you choose in the beginning of the deployment.

2.	Update the data source of the Power BI file
  -  Make sure you have installed the latest version of [Power BI desktop](https://powerbi.microsoft.com/desktop).

  -	In this GitHub repository, you can download the **'ManuQualityAssurance.pbix'** file under the folder **'Automated Deployment Guide'** and then open it. **Note:** You can't right click and download the Power BI Desktop file. Rather click on it and then use the "Download" button on the right hand side of the git page (or clone the repository). If you see an error massage, please make sure you have installed the latest version of Power BI Desktop.

  - On the top of the file, click **‘Edit Queries’** drop down menu. Then choose **'Data Source Settings'**.
  ![](Figures/PowerBI-7.png)

  - In the pop out window, click **'Change Source'**, then replace the **"Server"** and **"Database"** with your own server and database names and click **"OK"** for both data sources listed (this is different views on the same underlying data source). For server name, make sure you specify the port 1433 in the end of your server string
  (**YourSolutionName.database.windows.net, 1433**). After you finish editing, close the 'Data Source Settings' window.

  - On the top of the screen, you will see a message. Click **'Apply Changes'**. A new window will pop out and ask for database credentials. Click **'Database'** on the left of the window, enter your SQL credentials. For ***'Select which level to apply these settings to'***, choose the second one with database name. Then click ***'Connect'***.

  - Now the dashboard is updated to connect to your database. In the backend, model is scheduled to be refreshed every 1 hour. You can click **'Refresh'** button on the top to get the latest visualization as time moving forward.

3. (Optional) Publish the dashboard to [Power BI online](http://www.powerbi.com/).
    Note that this step needs a Power BI account (or Office 365 account).

      - Click **"Publish"** on the top panel. Choose **'My Workspace'** and few seconds later a window appears displaying "Publishing succeeded".

      - Click the link on the screen to open it in a browser. On the left panel, go to the **Dataset** section, right click the appropriate dataset, choose **Dataset Settings**. In the pop out window, click **Enter credentials** and enter your database credentials by following the instructions. To find detailed instructions, please see [Publish from Power BI Desktop](https://support.powerbi.com/knowledgebase/articles/461278-publish-from-power-bi-desktop).

      - Now you can see new items showing under 'Reports' and 'Datasets'. To create a new dashboard: click the **'+'** sign next to the
        **Dashboards** section on the left pane. Enter the name "Energy Demand Forecasting Demo" for this new dashboard.

      - Once you open the report, click   ![Pin](https://github.com/Azure/cortana-intelligence-quality-assurance-manufacturing/blob/master/Automated%20Deployment%20Guide/Figures/PowerBI-4.png?raw=true) to pin all the
		visualizations to your dashboard. To find detailed instructions, see [Pin a tile to a Power BI dashboard from a report](https://support.powerbi.com/knowledgebase/articles/430323-pin-a-tile-to-a-power-bi-dashboard-from-a-report). Here is an example of the dashboard.

      ![Dashboard Example](https://cloud.githubusercontent.com/assets/9042064/20732304/23c67ee2-b65c-11e6-969a-0a8f81bf5963.PNG)
