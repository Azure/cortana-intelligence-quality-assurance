{
    "contentVersion": "1.0.0.0",
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "parameters": {
        "baseUrl": { 
            "type": "string"
        },
        "powerBiUserId": {
            "type": "string",
            "metadata": {
                "description": "User ID for PowerBI"
            }
        },
        "powerBiUserDisplayName": {
            "type": "string",
            "metadata": {
                "description": "User display name for PowerBI"
            }
        }
    },
    "variables": {
        "namePrefix": "[resourceGroup().name]",
        "uniqueNamePrefix": "[concat(variables('namePrefix'), uniqueString(subscription().subscriptionId))]",
        "location": "[resourceGroup().location]",
		
        "experimentGalleryUrl0": "https://gallery.cortanaintelligence.com/Details/prediction-model-mk-iiii-w-p-0-predictive-exp-1",
        "experimentPackageUrl0": "https://storage.azureml.net/directories/1c39426f62e54751bac2237b5893d24b/items",
        "experimentEntityId0": "Prediction-Model-Mk-IIII-w-p-0-Predictive-Exp-1",
		
        "experimentGalleryUrl1": "https://gallery.cortanaintelligence.com/Details/prediction-model-mk-iiii-w-p-1-predictive-exp-1",
        "experimentPackageUrl1": "https://storage.azureml.net/directories/13b96963871d4c449863a01c8f0f627b/items",
        "experimentEntityId1": "Prediction-Model-Mk-IIII-w-p-1-Predictive-Exp-1",
		
        "experimentGalleryUrl2": "https://gallery.cortanaintelligence.com/Details/prediction-model-mk-iiii-w-p-2-predictive-exp-1",
        "experimentPackageUrl2": "https://storage.azureml.net/directories/a768af08ffad44339d89bb9bf59a6f2e/items",
        "experimentEntityId2": "Prediction-Model-Mk-IIII-w-p-2-Predictive-Exp-1",
		
        "experimentGalleryUrl3": "https://gallery.cortanaintelligence.com/Details/prediction-model-mk-iiii-w-p-3-predictive-exp-1",
        "experimentPackageUrl3": "https://storage.azureml.net/directories/664c336d23f44cc493a90157ff6ff426/items",
        "experimentEntityId3": "entityId=Prediction-Model-Mk-IIII-w-p-3-Predictive-Exp-1",
		
        "experimentGalleryUrl4": "https://gallery.cortanaintelligence.com/Details/prediction-model-mk-iiii-w-p-4-predictive-exp-1",
        "experimentPackageUrl4": "https://storage.azureml.net/directories/de6eb34d8cf74b249d36eb5878e1816d/items",
        "experimentEntityId4": "Prediction-Model-Mk-IIII-w-p-4-Predictive-Exp-1",

        "stgVersion": "2015-06-15",
		"storageAccountName": "[concat(substring(toLower(resourceGroup().name),0,4), substring(uniqueString(resourceGroup().id),0,8))]",
        "storageAccountType": "Standard_LRS",

        "mlVersion": "2016-04-01",
        "mlWorkspaceName": "[concat(variables('namePrefix'),'mlwk')]",

        
        "sbVersion": "2014-09-01",
        "sbKeyName": "RootManageSharedAccessKey",
        "namespaceName": "[concat(variables('uniqueNamePrefix'),'ns')]",
        "ingestEventHubName": "[concat(variables('namePrefix'),'eh')]",
		"waypoint02ConsumerGroup": "waypoint02",
		"waypoint34ConsumerGroup": "waypoint34",
 

        "sbKeyResourceId": "[resourceId('Microsoft.Eventhub/namespaces/authorizationRules', variables('namespaceName'), variables('sbKeyName'))]",
        "sbResourceId": "[resourceId('Microsoft.Eventhub/namespaces', variables('namespaceName'))]",
		"mlResourceId": "[resourceId('Microsoft.MachineLearning/workspaces', variables('mlWorkspaceName'))]",
        "stgResourceId": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",

		
		"sfVersion": "2016-03-01",
        "wsVersion": "2016-03-01",
        "hostingPlanName": "[concat(variables('uniqueNamePrefix'), 'sf')]",
        "appspsku": "Standard",
        "workerSize": "1",
        "webSitePackageUrl": "[concat(parameters('baseUrl'), '/', 'ManufacturingWjs.zip')]",
        "webJobSiteName": "[concat(variables('uniqueNamePrefix'), 'ws')]",
        "mlWebJobName": "ManufacturingMLCopyJob",
        "dataGenWebJobName": "ManfuacturingGenerator",

        "sfResourceId": "[resourceId('Microsoft.Web/serverFarms', variables('hostingPlanName'))]"
    },
    "resources": [
        {
            "apiVersion": "[variables('stgVersion')]",
            "name": "[variables('storageAccountName')]",
            "type": "Microsoft.Storage/storageAccounts",
            "location": "[variables('location')]",
            "properties": {
                "accountType": "[variables('storageAccountType')]"
            }
        },
        {
            "apiVersion": "[variables('mlVersion')]",
            "type": "Microsoft.MachineLearning/workspaces",
            "name": "[variables('mlWorkspaceName')]",
            "location": "[variables('location')]",
            "dependsOn": [
                "[variables('stgResourceId')]"
            ],
            "properties": {
                "UserStorageAccountId": "[variables('stgResourceId')]"
            }
        },
        {
            "apiVersion": "[variables('sbVersion')]",
            "name": "[variables('namespaceName')]",
            "type": "Microsoft.EventHub/namespaces",
            "location": "[variables('location')]",
            "properties": {
                "region": "[variables('location')]"
            },
            "resources": [
                {
                    "apiVersion": "[variables('sbVersion')]",
                    "name": "[variables('ingestEventHubName')]",
                    "type": "eventHubs",
                    "location": "[variables('location')]",
                    "dependsOn": [
                        "[variables('sbResourceId')]"
                    ],
                    "properties": {
                        "path": "[variables('ingestEventHubName')]"
                    },
					"resources": [
                        {
                            "apiVersion": "[variables('sbVersion')]",
                            "type": "ConsumerGroups",
                            "name": "[variables('waypoint02ConsumerGroup')]",
                            "dependsOn": [
                                "[variables('ingestEventHubName')]"
                            ],
                            "properties": {
                                "enableCheckpoint": "false"
                            }
                        },
                        {
                            "apiVersion": "[variables('sbVersion')]",
                            "type": "ConsumerGroups",
                            "name": "[variables('waypoint34ConsumerGroup')]",
                            "dependsOn": [
                                "[variables('ingestEventHubName')]"
                            ],
                            "properties": {
                                "enableCheckpoint": "false"
                            }
                        }
                    ],
                    "metadata": {
                        "description": "Create the Ingest Event Hub"
                    }
                }
            ]
        },
		{
            "apiVersion": "[variables('sfVersion')]",
            "name": "[variables('hostingPlanName')]",
            "type": "Microsoft.Web/serverFarms",
            "location": "[variables('location')]",
            "properties": {
                "name": "[variables('hostingPlanName')]",
                "workerSize": "[variables('workerSize')]",
                "numberOfWorkers": 1
            },
            "sku": {
                "name": "S1",
                "tier": "[variables('appspsku')]",
                "size": "S1",
                "family": "S",
                "capacity": "1"
            }
        },
        {
            "apiVersion": "[variables('wsVersion')]",
            "name": "[variables('webJobSiteName')]",
            "type": "Microsoft.Web/Sites",
            "location": "[variables('location')]",
            "dependsOn": [
                "[variables('sfResourceId')]",
                "[variables('mlResourceId')]",
                "[variables('sbResourceId')]"
            ],
            "tags": {
                "[concat('hidden-related:', variables('sfResourceId'))]": "empty"
            },
            "properties": {
                "name": "[variables('webJobSiteName')]",
                "serverFarmId": "[variables('hostingPlanName')]",
                "siteConfig": {
                    "AlwaysOn": true,
                    "appSettings": [
                        {
                            "Name": "Destination",
                            "Value": "eventhub"
                        },
                        {
                            "Name": "EventHubName",
                            "Value": "[variables('ingestEventHubName')]"
                        },
                        {
                            "Name": "EventHubConnectionString",
                            "Value": "[listkeys(variables('sbKeyResourceId'), variables('sbVersion')).primaryConnectionString]"
                        },
                        {
                            "Name": "HubFormat",
                            "Value": "json"
                        },
                        {
                            "Name": "MlWorkspaceLocation",
                            "Value": "[variables('location')]"
                        },
                        {
                            "Name": "MlWorkspaceId",
                            "Value": "[reference(variables('mlResourceId'), variables('mlVersion')).WorkspaceId]"
                        },
                        {
                            "Name": "MlWorkspaceToken",
                            "Value": "[listWorkspaceKeys(variables('mlResourceId'), variables('mlVersion')).primaryToken]"
                        },
                        {
                            "Name": "ExperimentGalleryUrl0",
                            "Value": "[variables('experimentGalleryUrl0')]"
                        },
                        {
                            "Name": "ExperimentPackageUrl0",
                            "Value": "[variables('experimentPackageUrl0')]"
                        },
                        {
                            "Name": "ExperimentEntityId0",
                            "Value": "[variables('experimentEntityId0')]"
                        },
                        {
                            "Name": "ExperimentGalleryUrl1",
                            "Value": "[variables('experimentGalleryUrl1')]"
                        },
                        {
                            "Name": "ExperimentPackageUrl1",
                            "Value": "[variables('experimentPackageUrl1')]"
                        },
                        {
                            "Name": "ExperimentEntityId1",
                            "Value": "[variables('experimentEntityId1')]"
                        },
                        {
                            "Name": "ExperimentGalleryUrl2",
                            "Value": "[variables('experimentGalleryUrl2')]"
                        },
                        {
                            "Name": "ExperimentPackageUrl2",
                            "Value": "[variables('experimentPackageUrl2')]"
                        },
                        {
                            "Name": "ExperimentEntityId2",
                            "Value": "[variables('experimentEntityId2')]"
                        },
                        {
                            "Name": "ExperimentGalleryUrl3",
                            "Value": "[variables('experimentGalleryUrl3')]"
                        },
                        {
                            "Name": "ExperimentPackageUrl3",
                            "Value": "[variables('experimentPackageUrl3')]"
                        },
                        {
                            "Name": "ExperimentEntityId3",
                            "Value": "[variables('experimentEntityId3')]"
                        },
                        {
                            "Name": "ExperimentGalleryUrl4",
                            "Value": "[variables('experimentGalleryUrl4')]"
                        },
                        {
                            "Name": "ExperimentPackageUrl4",
                            "Value": "[variables('experimentPackageUrl4')]"
                        },
                        {
                            "Name": "ExperimentEntityId4",
                            "Value": "[variables('experimentEntityId4')]"
                        },
                        {
                            "Name": "SCM_COMMAND_IDLE_TIMEOUT",
                            "Value": "1200"
                        },
                        {
                            "Name": "WEBJOBS_IDLE_TIMEOUT",
                            "Value": "1800"
                        }
                    ]
                }
            },
            "resources": [
                {
                    "apiVersion": "[variables('wsVersion')]",
                    "name": "MSDeploy",
                    "type": "extensions",
                    "dependsOn": [
                        "[resourceId('Microsoft.Web/Sites', variables('webJobSiteName'))]"
                    ],
                    "properties": {
                        "packageUri": "[variables('webSitePackageUrl')]",
                        "dbType": "None",
                        "connectionString": "",
                        "setParameters": {
                        }
                    }
                }
            ]
        }		
    ],
    "outputs": {
        "powerBiUserId": { "type": "string", "value": "[parameters('powerBiUserId')]" },
        "powerBiUserDisplayName": { "type": "string", "value": "[parameters('powerBiUserDisplayName')]" },
		
        "storageAccountName": { "type": "string", "value": "[variables('storageAccountName')]" },
        "storageAccountKey": { "type": "string", "value": "[listKeys(variables('stgResourceId'), variables('stgVersion')).key1]" },
        
		"mlWorkspaceObject": { "type": "object", "value": "[reference(variables('mlResourceId'), variables('mlVersion'))]" },
        "mlWorkspaceId" : {"type": "string", "value": "[reference(variables('mlResourceId'), variables('mlVersion')).WorkspaceId]"},
        "mlWorkspaceToken" : {"type": "string", "value": "[listWorkspaceKeys(variables('mlResourceId'), variables('mlVersion')).primaryToken]"},
        "mlWorkspaceLocation" : {"type": "string", "value": "[variables('location')]"},
		
		"ingestEventHubName": { "type": "string", "value": "[variables('ingestEventHubName')]" },
        "ehConnectionString": { "type": "string", "value": "[listkeys(variables('sbKeyResourceId'), variables('sbVersion')).primaryConnectionString]" },
        "sharedAccessPolicyKey": { "type": "string", "value": "[listKeys(variables('sbKeyResourceId'), variables('sbVersion')).primaryKey]" },
        "sbKeyName": { "type": "string", "value": "[variables('sbKeyName')]" },
        "namespaceName": { "type": "string", "value": "[variables('namespaceName')]" },
        "waypoint02ConsumerGroup": { "type": "string", "value": "[variables('waypoint02ConsumerGroup')]" },
        "waypoint34ConsumerGroup": { "type": "string", "value": "[variables('waypoint34ConsumerGroup')]" },


        "webJobSiteName": { "type": "string", "value": "[variables('webJobSiteName')]" },
        "webJobLogsUrl": { "type": "string", "value": "[concat('https://', variables('webJobSiteName'), '.scm.azurewebsites.net/azurejobs/#/jobs')]" },

        "mlSvcWebJobName": { "type": "string", "value": "[variables('mlWebJobName')]" },
        "dataGenWebJobName": { "type": "string", "value": "[variables('dataGenWebJobName')]" }
    }
}
